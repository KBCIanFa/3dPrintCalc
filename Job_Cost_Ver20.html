<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>3D Printing Cost Calculator + Quote (v7)</title><style>*{box-sizing:border-box}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:linear-gradient(135deg,#eef2f3,#8e9eab);color:#111827}h1{margin:0;color:#0b74ff}label{font-weight:600;font-size:.95rem;color:#374151;display:block;margin:8px 0 6px}input,select,textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb;font-size:1rem}input:focus,select:focus,textarea:focus{outline:none;border-color:#0b74ff;box-shadow:0 0 0 3px rgba(11,116,255,.15)}textarea{min-height:70px;resize:vertical}.wrap{width:min(92vw,980px);margin:24px auto;padding:18px;border-radius:16px;background:#fff;box-shadow:0 8px 20px rgba(0,0,0,.08)}.row{display:grid;gap:12px}.c2{grid-template-columns:1fr 1fr}.c3{grid-template-columns:repeat(3,1fr)}@media(max-width:900px){.c2,.c3{grid-template-columns:1fr}}.section{margin:16px 0;padding:14px;border-left:4px solid #0b74ff;border-radius:10px;background:#f8fafc}.section h2{margin:0 0 8px;font-size:1.05rem;color:#4b5563}.sub{color:#6b7280}.btns{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin-top:10px}button{padding:10px 14px;border:0;border-radius:12px;background:#0b74ff;color:#fff;font-weight:700;cursor:pointer}button:hover{background:#075ed3}.b2{background:#0ea5e9}.b2:hover{background:#0b8ec7}.muted{background:#6b7280}.muted:hover{background:#565d65}.ghost{background:#eef2ff;color:#0b74ff}.ghost:hover{background:#e1e7ff}.result{margin-top:12px;padding:12px;border-radius:12px;background:#f7f9fa;box-shadow:0 4px 10px rgba(0,0,0,.06)}.kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-top:8px}.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px}.t{font-size:.8rem;color:#6b7280}.v{font-size:1.06rem;font-weight:700;margin-top:2px}.ok{background:#e8f7ef;border:1px solid #b7f0cf;color:#0a6a42;padding:8px;border-radius:8px;margin-bottom:8px}.warn{background:#fff4e5;border:1px solid #ffdca8;color:#8a5400;padding:8px;border-radius:8px;margin-bottom:8px}.ver{margin-top:6px;text-align:center;color:#9ca3af;font-size:.85rem}#quoteDoc{display:none}.quote{width:210mm;max-width:100%;margin:0 auto;background:#fff;color:#000;padding:22mm 18mm}.qh{display:flex;justify-content:space-between;gap:12px;margin-bottom:10px}.qh h2{margin:0;color:#0b74ff}.qs{margin:12px 0}.qt{width:100%;border-collapse:collapse;margin-top:6px}.qt th,.qt td{border:1px solid #e5e7eb;padding:8px;text-align:right}.qt th:first-child,.qt td:first-child{text-align:left}.qt tfoot td{font-weight:700}.qnotes{white-space:pre-wrap;border:1px solid #e5e7eb;border-radius:8px;padding:8px;background:#fafafa}@media print{body{background:#fff}.no-print{display:none!important}#quoteDoc{display:block}@page{size:A4;margin:12mm}}dialog{border:none;border-radius:14px;max-width:min(94vw,900px);width:900px;padding:0;box-shadow:0 24px 80px rgba(0,0,0,.25)}dialog::backdrop{background:rgba(0,0,0,.4)}dialog.force-center[open]{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%)}.shead{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #e5e7eb}.sbody{display:flex}.snav{width:210px;background:#f3f4f6;border-right:1px solid #e5e7eb;border-bottom-left-radius:14px;border-top-left-radius:14px;padding:12px}.snav button{display:block;width:100%;text-align:left;background:transparent;border:1px solid transparent;border-radius:10px;padding:10px;margin-bottom:8px}.snav .active{background:#fff;border-color:#e5e7eb}.smain{flex:1;padding:14px}.sgrid{display:grid;gap:10px;grid-template-columns:1fr 1fr}@media(max-width:760px){.sgrid{grid-template-columns:1fr}}.table{width:100%;border-collapse:collapse}.table th,.table td{border:1px solid #e5e7eb;padding:8px}.table th{background:#f9fafb;text-align:left}.toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin:8px 0}</style></head><body><div class="wrap no-print"><header style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px"><div><h1>3D Printing Cost Calculator</h1><div class="sub">Assumes <b>1 kg spools</b>. Customer‚Äësafe quotes. <b>v7</b></div></div><button id="btnSettings" class="ghost" type="button">‚öôÔ∏è Settings</button></header><form id="calcForm" onsubmit="return false;"><div class="section"><h2>Printer</h2><div class="row c2"><div><label for="printer">Select Printer</label><select id="printer" required></select></div><div><label for="machineBase">Machine Base $/hr (<span class="ccy">$</span>)</label><input id="machineBase" type="number" step="0.01" placeholder="Auto"/></div></div></div><div class="section"><h2>Filament</h2><div class="row c3"><div><label for="filamentType">Material</label><select id="filamentType"><option>PLA</option><option>ABS</option><option>PETG</option><option>Nylon</option><option>TPU</option><option>PC</option><option>CarbonFiber</option><option>ASA</option><option>Custom</option></select></div><div><label id="customDensityLabel" style="display:none">Custom Density (g/cm¬≥)</label><input id="customDensity" type="number" step="0.01" style="display:none"/></div><div><label for="filamentDiameter">Diameter (mm)</label><input id="filamentDiameter" type="number" step="0.01" value="1.75"/></div><div><label for="filamentPrice">Price/kg (<span class="ccy">$</span>)</label><input id="filamentPrice" type="number" step="0.01"/></div></div></div><div class="section"><h2>Print Details</h2><div class="row c3"><div><label>Time Mode</label><div style="display:flex;gap:10px;flex-wrap:wrap"><label style="display:flex;gap:6px;align-items:center"><input type="radio" name="timeMode" value="perModel" checked>Per model</label><label style="display:flex;gap:6px;align-items:center"><input type="radio" name="timeMode" value="totalJob">Total job</label></div></div><div><label for="printWeight">Part Weight (g)</label><input id="printWeight" type="number" step="0.1"/></div><div><label>Print Time <span id="timeModeTag" class="sub">(per model)</span></label><div class="row c2"><input id="printTimeHours" type="number" placeholder="Hours" min="0"><input id="printTimeMinutes" type="number" placeholder="Minutes" min="0"></div></div><div><label for="numModels">Number of Models</label><input id="numModels" type="number" step="1" value="1"></div></div></div><div class="section"><h2>Pricing</h2><div class="row c3"><div><label for="markup">Markup (%)</label><input id="markup" type="number" step="0.1" value="0"></div><div><label for="sellHourly">Target Sell $/hr (<span class="ccy">$</span>)</label><input id="sellHourly" type="number" step="0.1" placeholder="15"></div><div><label style="display:flex;gap:8px;align-items:center;margin-top:28px"><input type="checkbox" id="enforceMin" checked> Enforce minimum hourly & <span class="ccy" style="margin:0 4px">$</span>15/job</label></div></div><div class="sub">Std 12‚Äì15/hr ‚Ä¢ Eng 15‚Äì18/hr (auto‚Äëenforced).</div></div><div class="section"><h2>Quote Details</h2><div class="row c2"><div><label>Customer</label><input id="custName" placeholder="e.g. John Citizen"></div><div><label>Email</label><input id="custEmail" type="email" placeholder="john@example.com"></div><div><label>Project</label><input id="project" placeholder="ABS prototype brackets"></div><div><label>Valid (days)</label><input id="validDays" type="number" value="14"></div></div><div class="row c2"><div><label>Business</label><input id="bizName" placeholder="Your Business"></div><div><label>Tax/Business ID</label><input id="abn" placeholder="ABN / VAT / Tax ID"></div></div><div><label>Taxes for this quote</label><div id="taxList" class="row c3"></div><div class="sub">Manage tax types in Settings.</div></div><label>Notes / Terms</label><textarea id="notes" placeholder="Lead times, reprint policy, payment terms, etc."></textarea></div></form><div class="btns"><button id="btnCalc">Calculate</button><button class="b2" id="btnQuote">Build Quote</button><button class="muted" id="btnPrint">Print / Save as PDF</button><button class="b2" id="btnDownloadPdf">Download PDF</button><button class="ghost" id="btnDownloadHtml">Download HTML</button><button class="ghost" id="btnCopyEmail">Copy Email Summary</button><button class="muted" id="btnReset">Reset</button></div><div id="out" class="result" style="display:none"></div><div class="ver">v7 ‚Ä¢ full refactor (fixed Settings buttons, reliable dialog, newline-safe email, cleaner JS)</div></div><div id="quoteDoc"><div class="quote" id="quoteWrap"></div></div><dialog id="settings"><div class="shead"><strong>Settings</strong><div class="toolbar"><input type="file" id="importFile" accept="application/json" style="display:none"><button class="ghost" id="btnExport">Export</button><button class="ghost" id="btnImport">Import</button><button class="ghost" id="btnResetDefaults">Reset Defaults</button><button class="ghost" id="btnSaveSettings">Save</button><button class="muted" id="btnCloseSettings">Close</button></div></div><div class="sbody"><div class="snav"><button class="active" data-tab="country">üåç Country & Taxes</button><button data-tab="printers">üñ®Ô∏è Printers</button></div><div class="smain"><div class="stab" id="stab-country"><div class="sgrid"><div><label>Country</label><select id="s-country"><option>Australia</option><option>United States</option><option>United Kingdom</option><option>European Union</option><option>Canada</option><option>New Zealand</option></select></div><div><label>Locale</label><select id="s-locale"><option>en-AU</option><option>en-US</option><option>en-GB</option><option>en-CA</option><option>en-NZ</option></select></div><div><label>Currency</label><select id="s-currency"><option>AUD</option><option>USD</option><option>GBP</option><option>EUR</option><option>CAD</option><option>NZD</option></select></div></div><h3 style="margin:10px 0 6px">Taxes</h3><table class="table" id="taxTable"><thead><tr><th>Name</th><th>Rate %</th><th>On by default</th><th>Remove</th></tr></thead><tbody></tbody></table><div class="toolbar"><button type="button" class="ghost" id="btnAddTax">+ Add Tax</button></div></div><div class="stab" id="stab-printers" style="display:none"><table class="table" id="printerTable"><thead><tr><th>Name</th><th>$ / kWh</th><th>Power W</th><th>Deprec $/hr</th><th>Maint $/hr</th><th>Other $/hr</th><th>Base $/hr</th><th>Default</th><th>Remove</th></tr></thead><tbody></tbody></table><div class="toolbar"><button type="button" class="ghost" id="btnAddPrinter">+ Add Printer</button></div><div class="sub">Base/hr = (kWh √ó kW) + Deprec + Maint + Other</div></div></div></div></dialog><script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script><script>/* =======================
   3D Print Calculator v7
   ======================= */
const LS='calcSettingsV4';
const DEF={country:'Australia',locale:'en-AU',currency:'AUD',taxes:[{id:'GST',name:'GST',rate:10,enabled:true}],printers:[{id:'H2S',name:'Bambu Lab H2S',energyRate:0.30,powerW:150,depreciation:0.50,maintenance:0.35,other:0,basePerHr:1.15,default:true},{id:'A1',name:'Bambu Lab A1',energyRate:0.30,powerW:120,depreciation:0.40,maintenance:0.20,other:0,basePerHr:0.80,default:false}]};
const DENS={PLA:1.24,ABS:1.04,PETG:1.27,Nylon:1.52,TPU:1.21,PC:1.3,CarbonFiber:1.3,ASA:1.05};
const ENG=new Set(['ABS','ASA','Nylon','PC','CarbonFiber','PETG']);
const SPOOL=1000; // grams per roll

let S,last=null;
const $=id=>document.getElementById(id);
const q=(sel,root=document)=>Array.from(root.querySelectorAll(sel));

/* ---------- Storage ---------- */
function load(){try{const j=JSON.parse(localStorage.getItem(LS));return j&&Array.isArray(j.printers)&&j.printers.length?j:structuredClone(DEF)}catch{return structuredClone(DEF)}}
function save(){localStorage.setItem(LS,JSON.stringify(S))}
function exportSettings(){const blob=new Blob([JSON.stringify(S,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=Object.assign(document.createElement('a'),{href:url,download:'calculator_settings.json'});document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)}
function importSettings(file){const reader=new FileReader();reader.onload=e=>{try{const data=JSON.parse(e.target.result);if(!data||!Array.isArray(data.printers))throw new Error('Invalid file');S=data;save();applyUI();alert('Settings imported.')}catch{alert('Import failed. Ensure a valid settings JSON.')}};reader.readAsText(file)}
function resetDefaults(){S=structuredClone(DEF);save();applyUI();alert('Defaults restored.')} 

/* ---------- Formatters ---------- */
function sym(){try{return(0).toLocaleString(S.locale,{style:'currency',currency:S.currency,minimumFractionDigits:0,maximumFractionDigits:0}).replace(/0/g,'').trim()||'$'}catch{return'$'}}
function fmt(n){return Number(n).toLocaleString(S.locale,{minimumFractionDigits:2,maximumFractionDigits:2})}
function money(n){try{return new Intl.NumberFormat(S.locale,{style:'currency',currency:S.currency,minimumFractionDigits:2,maximumFractionDigits:2}).format(n)}catch{return `${sym()}${Number(n).toFixed(2)}`}}

/* ---------- Domain helpers ---------- */
function toggleCustomDensity(){const on=$('filamentType').value==='Custom';$('customDensityLabel').style.display=$('customDensity').style.display=on?'block':'none'}
function timeBadge(){const m=document.querySelector('input[name="timeMode"]:checked')?.value||'perModel';$('timeModeTag').textContent=m==='perModel'?'(per model)':'(total job)'}
function baseFor(p){const e=(+p.energyRate||0)*((+p.powerW||0)/1000);return e+(+p.depreciation||0)+(+p.maintenance||0)+(+p.other||0)}

/* ---------- UI builders ---------- */
function renderPrinterSelect(){const sel=$('printer');sel.innerHTML='';if(!S.printers.length){const o=document.createElement('option');o.value='';o.textContent='Add a printer in Settings';sel.appendChild(o);return}
 S.printers.forEach(p=>{const o=document.createElement('option');o.value=p.id;o.textContent=`${p.name} (base ~${money(p.basePerHr||baseFor(p))}/hr)`;sel.appendChild(o)});const d=S.printers.find(p=>p.default)||S.printers[0];sel.value=d.id;onPrinter()}
function onPrinter(){const p=S.printers.find(x=>x.id===$('printer').value);$('machineBase').value=(p?.basePerHr||baseFor(p)||0).toFixed(2)}
function renderTaxes(){const box=$('taxList');box.innerHTML='';S.taxes.forEach(t=>{if(!t.id) t.id=Math.random().toString(36).slice(2,7);const id=`tax_${t.id}`;const dv=document.createElement('div');dv.innerHTML=`<label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="${id}" ${t.enabled?'checked':''}> ${t.name} (${fmt(t.rate)}%)</label>`;box.appendChild(dv)})}
function applyCurrency(){q('.ccy').forEach(el=>el.textContent=sym())}

/* ---------- Calculator ---------- */
function calc(){const pid=$('printer').value,base=Math.max(0,parseFloat($('machineBase').value));const mat=$('filamentType').value;const dens=mat==='Custom'?parseFloat($('customDensity').value):DENS[mat];const dia=parseFloat($('filamentDiameter').value);const priceKg=Math.max(0,parseFloat($('filamentPrice').value));const w=parseFloat($('printWeight').value);const h=parseFloat($('printTimeHours').value);const m=parseFloat($('printTimeMinutes').value);const n=parseInt($('numModels').value,10)||0;const markup=Math.max(0,parseFloat($('markup').value)||0);const sell=parseFloat($('sellHourly').value)||0;const enforce=$('enforceMin').checked;const mode=document.querySelector('input[name="timeMode"]:checked')?.value||'perModel';const out=$('out');const err=t=>{out.style.display='block';out.innerHTML=`<div class=warn>${t}</div>`;return null};if(!pid)return err('Select a printer.');if(!(base>0))return err('Enter a valid Machine Base $/hr.');if(!(dens>0))return err('Enter a valid density or preset material.');if(!(dia>0))return err('Enter a valid filament diameter.');if(!(priceKg>0))return err('Enter a valid filament price/kg.');if(!(w>0))return err('Enter a valid part weight (g).');if(!(h>=0&&m>=0&&(h||m)))return err('Enter a valid print time.');if(!(n>0))return err('Enter a valid number of models.');
 // filament length from mass & density
 const r=dia/2,a=Math.PI*r*r,cm3=a/1000,gPerMM=dens*cm3,mmPerG=1/gPerMM,lenM1=(w*mmPerG)/1000; // m per model
 const totalG=w*n,rolls=Math.ceil(totalG/SPOOL),left=rolls*SPOOL-totalG;
 const tH=h+m/60;const per=mode==='perModel'?tH:(tH/n);const jobH=per*n; // hours
 const matCost=(w/1000)*priceKg*n;const machCost=jobH*base;const pre=matCost+machCost;const raw=pre*(1+markup/100);
 const eng=ENG.has(mat),gMin=eng?15:12,gMax=eng?18:15,minJob=15;const target=sell?Math.max(sell,gMin):gMin;let rev=raw;if(enforce){const need=matCost+target*jobH;rev=Math.max(raw,need,minJob)}
 const adj=rev>raw+1e-6;const perModel=rev/n;const realised=jobH?((rev-matCost)/jobH):0;
 last={pid,mat,dens,dia,priceKg,w,n,per,jobH,matCost,machCost,pre,rev,perModel,realised,eng,gMin,gMax,minJob,lenM1,totalG,rolls,left,adj};
 out.style.display='block';
 out.innerHTML=`${adj?`<div class=warn><b>Adjusted pricing:</b> Raised to meet minimums (${eng?'Engineering/high‚Äëtemp':'Standard'} ${gMin}‚Äì${gMax}/hr and ${money(minJob)} min).</div>`:`<div class=ok>Revenue positive</div>`}<div class=kpi><div class=card><div class=t>Printer</div><div class=v>${S.printers.find(p=>p.id===pid)?.name||pid}</div></div><div class=card><div class=t>Filament (g)</div><div class=v>${fmt(totalG)}</div></div><div class=card><div class=t>Spools (1 kg)</div><div class=v>${rolls} (left ${fmt(left)} g)</div></div><div class=card><div class=t>Length (m √ó models)</div><div class=v>${fmt(lenM1*n)}</div></div><div class=card><div class=t>Material</div><div class=v>${money(matCost)}</div></div><div class=card><div class=t>Machine</div><div class=v>${money(machCost)}</div></div><div class=card><div class=t>Final price</div><div class=v>${money(rev)}</div></div><div class=card><div class=t>Price per model</div><div class=v>${money(perModel)}</div></div><div class=card><div class=t>Realised $/hr</div><div class=v>${money(realised)}</div></div></div>`;return last}

function taxesSelected(){const list=[];S.taxes.forEach(t=>{const cb=$("tax_"+(t.id||''));if(cb&&cb.checked)list.push({name:t.name,rate:+t.rate})});return list}

/* ---------- Quote ---------- */
function buildQuote(){const c=last||calc();if(!c)return;const now=new Date(),y=now.getFullYear(),mm=String(now.getMonth()+1).padStart(2,'0'),dd=String(now.getDate()).padStart(2,'0'),qid=`Q-${y}${mm}${dd}-${String(now.getTime()).slice(-5)}`,vd=parseInt($('validDays').value,10)||14,vu=new Date(now.getTime()+vd*864e5),vustr=`${vu.getFullYear()}-${String(vu.getMonth()+1).padStart(2,'0')}-${String(vu.getDate()).padStart(2,'0')}`;const cust=$('custName').value||'',email=$('custEmail').value||'',proj=$('project').value||'',biz=$('bizName').value||'3D Print Services',abn=$('abn').value||'',notes=$('notes').value||'';const taxes=taxesSelected();const sub=c.rev;const taxRows=taxes.map(t=>({name:t.name,rate:t.rate,amt:sub*(t.rate/100)}));const totalTax=taxRows.reduce((a,b)=>a+b.amt,0);const grand=sub+totalTax;const prName=S.printers.find(p=>p.id===c.pid)?.name||c.pid;$('quoteWrap').innerHTML=`<div class=qh><div><h2>${biz}</h2>${abn?`<div>${abn}</div>`:''}</div><div><div><b>Quote:</b> ${qid}</div><div><b>Date:</b> ${y}-${mm}-${dd}</div><div><b>Valid until:</b> ${vustr}</div></div></div><div class=qs><div class=sub>To</div><div>${cust||'Customer'}</div>${email?`<div>${email}</div>`:''}</div><div class=qs><div class=sub>Project</div><div>${proj|| (c.mat+' print')}</div></div><div class=qs><table class=qt><thead><tr><th>Description</th><th>Qty</th><th>Unit</th><th>Amount</th></tr></thead><tbody><tr><td>3D printing service (materials & setup included; ${c.n} model(s); material ${c.mat}; printer ${prName})</td><td>1</td><td>job</td><td>${money(sub)}</td></tr></tbody><tfoot><tr><td colspan=3>Subtotal</td><td>${money(sub)}</td></tr>${taxRows.map(t=>`<tr><td colspan=3>${t.name} (${fmt(t.rate)}%)</td><td>${money(t.amt)}</td></tr>`).join('')}<tr><td colspan=3>Grand Total</td><td>${money(grand)}</td></tr></tfoot></table></div><div class=qs><table class=qt><tbody><tr><td>Models</td><td>${c.n}</td></tr><tr><td>Material type</td><td>${c.mat}</td></tr><tr><td>Filament used (g)</td><td>${fmt(c.totalG)}</td></tr><tr><td>Spools required (1 kg)</td><td>${c.rolls} (leftover ~${fmt(c.left)} g)</td></tr><tr><td>Filament length (m)</td><td>${fmt(c.lenM1*c.n)}</td></tr><tr><td>Total print time (hr)</td><td>${fmt(c.jobH)}</td></tr><tr><td>Time mode</td><td>${($('timeModeTag').textContent||'').replace(/[()]/g,'')}</td></tr><tr><td>Price per model</td><td>${money(c.perModel)}</td></tr><tr><td>Minimum job policy</td><td>${money(c.minJob)} minimum applies${c.rev<c.minJob?' (adjusted)':''}</td></tr></tbody></table></div>${notes?`<div class=qs><div class=qnotes>${notes}</div></div>`:''}<div class=sub>Thank you. Please reply to confirm acceptance.</div>`}
function printQuote(){if(!last)buildQuote();window.print()} 
function downloadHTML(){if(!last)buildQuote();const html=`<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Quote</title><style>${document.querySelector('style').innerHTML}</style></head><body>${$('quoteDoc').innerHTML}</body></html>`;const blob=new Blob([html],{type:'text/html'});const url=URL.createObjectURL(blob);const fn=(`Quote_${($('custName').value||'customer').replace(/[^a-z0-9-_]+/gi,'_')}.html`);const a=Object.assign(document.createElement('a'),{href:url,download:fn});document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)}
function downloadPDF(){const r=last||calc();if(!r)return;buildQuote();const qd=$('quoteDoc'),pd=qd.style.display,pp=qd.style.position,pl=qd.style.left;qd.style.display='block';qd.style.position='fixed';qd.style.left='-10000px';const el=$('quoteWrap');const name=($('custName').value||'customer').replace(/[^a-z0-9-_]+/gi,'_');try{const{jsPDF}=window.jspdf||{};if(!window.html2canvas||!jsPDF)throw new Error('PDF libs missing');html2canvas(el,{scale:2,useCORS:true,backgroundColor:'#fff'}).then(cv=>{const img=cv.toDataURL('image/png');const pdf=new jsPDF('p','mm','a4');const pw=pdf.internal.pageSize.getWidth(),ph=pdf.internal.pageSize.getHeight(),m=10,iw=pw-m*2,ih=cv.height*iw/cv.width;let left=ih;pdf.addImage(img,'PNG',m,m,iw,ih);left-=ph-m*2;while(left>0){pdf.addPage();const pos=m-(ih-left);pdf.addImage(img,'PNG',m,pos,iw,ih);left-=ph-m*2}pdf.save(`Quote_${name}.pdf`);qd.style.display=pd;qd.style.position=pp;qd.style.left=pl}).catch(()=>{qd.style.display=pd;qd.style.position=pp;qd.style.left=pl;alert('Could not render PDF. Use Print / Save as PDF instead.')})}catch(e){qd.style.display=pd;qd.style.position=pp;qd.style.left=pl;alert('PDF not supported. Use Print / Save as PDF.')}}
function copyEmail(){const c=last||calc();if(!c)return;const taxes=taxesSelected();const sub=c.rev;const lines=[];lines.push(`Hi ${$('custName').value||'there'},`,'',`Here\'s your quote for ${$('project').value|| (c.mat+' print')}:`,'',`‚Ä¢ 3D printing service ‚Äî ${c.n} √ó model(s)`,`‚Ä¢ Material: ${c.mat}`,`‚Ä¢ Filament used: ${fmt(c.totalG)} g (${c.rolls} √ó 1 kg spools; leftover ~${fmt(c.left)} g)`,`‚Ä¢ Estimated print time: ${fmt(c.jobH)} hr`,'',`Subtotal: ${money(sub)}`);taxes.forEach(t=>lines.push(`${t.name} (${fmt(t.rate)}%): ${money(sub*(t.rate/100))}`));lines.push(`Total: ${money(sub+taxes.reduce((a,t)=>a+sub*(t.rate/100),0))}`,'',`Per model price: ${money(c.perModel)}`,`Valid for ${$('validDays').value||14} days.`,'',`Thanks,`,`${$('bizName').value||'‚Äî'}`);const text=lines.join('
');navigator.clipboard.writeText(text).then(()=>alert('Quote summary copied.')).catch(()=>{const ta=document.createElement('textarea');ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();alert('Quote summary copied.')})}
function resetAll(){document.getElementById('calcForm').reset();$('out').style.display='none';$('quoteWrap').innerHTML='';last=null;toggleCustomDensity();timeBadge();applyCurrency();renderTaxes()}

/* ---------- Settings UI ---------- */
function openSettings(){const d=$('settings');renderSettings();try{if(d.showModal){d.showModal()}else if(d.show){d.show()}else{d.setAttribute('open','');d.classList.add('force-center')}}catch(e){d.setAttribute('open','');d.classList.add('force-center')}}
function closeSettings(){const d=$('settings');try{if(d.close){d.close()}else{d.removeAttribute('open')}}catch(e){d.removeAttribute('open')}d.classList.remove('force-center')}
function renderSettings(){q('.snav button').forEach(b=>b.onclick=()=>{q('.snav button').forEach(x=>x.classList.remove('active'));b.classList.add('active');q('.stab').forEach(x=>x.style.display='none');$('stab-'+b.dataset.tab).style.display='block'});$('s-country').value=S.country;$('s-locale').value=S.locale;$('s-currency').value=S.currency;renderTaxTable();renderPrinterTable()}
function renderTaxTable(){const tb=$('taxTable').querySelector('tbody');tb.innerHTML='';S.taxes.forEach((t,i)=>{if(!t.id) t.id=Math.random().toString(36).slice(2,7);const tr=document.createElement('tr');tr.innerHTML=`<td><input value="${t.name}"></td><td><input type=number step=0.1 value="${t.rate}"></td><td style=text-align:center><input type=checkbox ${t.enabled?'checked':''}></td><td><button data-del=${i} class=muted>Delete</button></td>`;tb.appendChild(tr)});tb.onclick=e=>{if(e.target.dataset.del){S.taxes.splice(+e.target.dataset.del,1);renderTaxTable()}};$('btnAddTax').onclick=()=>{S.taxes.push({id:Math.random().toString(36).slice(2,7),name:'Tax',rate:10,enabled:false});renderTaxTable()}}
function renderPrinterTable(){const tb=$('printerTable').querySelector('tbody');tb.innerHTML='';S.printers.forEach((p,i)=>{const base=p.basePerHr||baseFor(p);const tr=document.createElement('tr');tr.innerHTML=`<td><input value="${p.name}"></td><td><input type=number step=0.001 value="${p.energyRate}"></td><td><input type=number step=1 value="${p.powerW}"></td><td><input type=number step=0.01 value="${p.depreciation}"></td><td><input type=number step=0.01 value="${p.maintenance}"></td><td><input type=number step=0.01 value="${p.other}"></td><td>${money(base)}</td><td style=text-align:center><input type=radio name=defp ${p.default?'checked':''}></td><td><button data-del=${i} class=muted>Delete</button></td>`;tb.appendChild(tr)});tb.onclick=e=>{if(e.target.dataset.del){S.printers.splice(+e.target.dataset.del,1);renderPrinterTable()}};$('btnAddPrinter').onclick=()=>{S.printers.push({id:'P'+Math.random().toString(36).slice(2,8),name:'New Printer',energyRate:0.30,powerW:120,depreciation:0.50,maintenance:0.20,other:0});renderPrinterTable()}}
function collectAndSaveSettings(){S.country=$('s-country').value;S.locale=$('s-locale').value;S.currency=$('s-currency').value;const trows=q('#taxTable tbody tr');S.taxes=Array.from(trows).map(tr=>({id:Math.random().toString(36).slice(2,7),name:tr.cells[0].querySelector('input').value||'Tax',rate:+tr.cells[1].querySelector('input').value||0,enabled:tr.cells[2].querySelector('input').checked}));const prows=q('#printerTable tbody tr');const mapped=Array.from(prows).map((tr,i)=>({id:S.printers[i]?.id||('P'+Math.random().toString(36).slice(2,8)),name:tr.cells[0].querySelector('input').value||'Printer',energyRate:+tr.cells[1].querySelector('input').value||0,powerW:+tr.cells[2].querySelector('input').value||0,depreciation:+tr.cells[3].querySelector('input').value||0,maintenance:+tr.cells[4].querySelector('input').value||0,other:+tr.cells[5].querySelector('input').value||0,basePerHr:0,default:tr.cells[7].querySelector('input').checked}));let seen=false;S.printers=mapped.map(p=>{p.basePerHr=p.basePerHr||baseFor(p);if(p.default&&!seen){seen=true;return p}else{return {...p,default:false}}});if(!seen&&S.printers[0])S.printers[0].default=true;save();applyUI();alert('Settings saved.')}

/* ---------- Apply / Init ---------- */
function applyUI(){renderPrinterSelect();renderTaxes();applyCurrency();timeBadge()}
window.addEventListener('DOMContentLoaded',()=>{S=load();applyUI();
 $('btnCalc').addEventListener('click',calc);
 $('btnQuote').addEventListener('click',()=>{if(calc())buildQuote()});
 $('btnPrint').addEventListener('click',()=>{if(calc())buildQuote();printQuote()});
 $('btnDownloadHtml').addEventListener('click',()=>{if(calc())buildQuote();downloadHTML()});
 $('btnDownloadPdf').addEventListener('click',()=>{if(calc())buildQuote();downloadPDF()});
 $('btnCopyEmail').addEventListener('click',()=>{if(calc())copyEmail()});
 $('btnReset').addEventListener('click',resetAll);
 $('filamentType').addEventListener('change',toggleCustomDensity);
 q('input[name="timeMode"]').forEach(r=>r.addEventListener('change',timeBadge));
 $('printer').addEventListener('change',onPrinter);
 // settings
 $('btnSettings').addEventListener('click',openSettings);
 $('btnCloseSettings').addEventListener('click',closeSettings);
 $('btnSaveSettings').addEventListener('click',collectAndSaveSettings);
 $('btnExport').addEventListener('click',exportSettings);
 $('btnImport').addEventListener('click',()=>$('importFile').click());
 $('importFile').addEventListener('change',e=>{const f=e.target.files?.[0];if(f) importSettings(f)});
 $('btnResetDefaults').addEventListener('click',resetDefaults);
});
</script></body></html>
